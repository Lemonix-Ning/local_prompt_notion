# Local Prompt Notion 开发记录（2026-01-10）

本文记录本次对 **Local Prompt Notion** 的一次较大规模迭代：

- 回收站“打开网站计数 + 自动永久删除 + UI 显示访问次数”
- “改分类 = 移动目录”的分类同步方案（目录结构即真相）
- UI 按 `view.md` 重设计：暗色玻璃拟态、网格/极光背景、Spotlight 卡片、智能 Logo
- Windows/Chromium 下拉/闪烁等细节问题的排查与修复

目标是让你后续遇到类似问题时能快速定位：**问题现象 → 根因 → 排查路径 → 修复方式 → 相关代码位置**。

---

## 1. 项目背景与约束

### 1.1 项目定位

- 所有 Prompt 数据存放在本地文件系统（Vault）
- 分类树 = 文件夹结构；Prompt = 子文件夹（包含 `meta.json` / `prompt.md`）
- 前端 React + Vite；后端 Node + Express

### 1.2 关键约束

- Windows 路径分隔符（`\` vs `/`）、大小写、`path.normalize` 的差异要特别注意
- “分类树显示”与“实际目录”必须一致，不能出现 UI 与磁盘不同步
- 回收站是特殊目录（`vaultRoot/trash`）

---

## 2. 功能一：回收站访问计数 & 自动清理

### 2.1 需求

- 每次打开/刷新网站计 1 次（不是点击回收站才算）
- 回收站中的条目累计访问次数达到阈值（10）后，自动永久删除该 Prompt 文件夹及内容
- UI 在回收站列表上显示：`x/10`

### 2.2 设计方案

- 后端保存访问计数到：`vaultRoot/trash/.trash-visits.json`
- 每次 app load 调用 `POST /api/trash/visit`：
  - 计数 +1
  - 遍历 trash 目录，如果计数 >= threshold 则调用永久删除
  - 清理 JSON 中已不存在的条目
- 前端回收站页面拉取 `GET /api/trash/status` 显示计数

### 2.3 实现位置

- 后端：
  - `server/routes/trash.js`
  - `server/index.js` 注册 `/api/trash`
- 前端：
  - `src/App.tsx`：启动时调用 `api.trash.visit(10)`
  - `src/components/PromptList.tsx`：回收站视图调用 `api.trash.status(10)` 并显示 `x/10`

### 2.4 排查与坑点

- **坑：计数触发时机错误**
  - 初版把计数放在“点击回收站”事件里，导致用户不点就不计数
  - 修复：移动到 `App.tsx` 的首次加载 `useEffect`，保证每次打开站点都计数

- **坑：计数文件条目与实际目录不同步**
  - 如果用户手动删除/移动 trash 文件夹，JSON 会残留
  - 修复：每次 visit/status 都清理不存在的 key

---

## 3. 功能二：分类同步（改分类 = 移动目录）

### 3.1 需求

- 编辑 Prompt 时修改分类，应当让 **Prompt 目录在磁盘上移动到目标分类目录**
- UI 分类树、真实目录、`meta` 字段必须一致
- 回收站恢复时优先恢复到 `original_path`，其次按分类恢复

### 3.2 关键数据协议

新增 `meta.category_path`（分类目录的权威路径）：

- `meta.category`：分类名称（用于标签/展示）
- `meta.category_path`：分类目录真实路径（用于移动/恢复/同步）

前端保存时发送：

- `PUT /api/prompts/:id` Body 增加 `categoryPath`

### 3.3 后端实现

- `server/utils/fileSystem.js`
  - `movePrompt(promptPath, newCategoryPath, vaultRoot)`：
    - `fs.rename` 移动 prompt 文件夹
    - 若目标同名冲突，自动加 `_moved_1` 后缀
    - 更新 meta：`category_path`、`category`
  - `restorePrompt`：
    - 优先使用 `meta.original_path`
    - 其次使用 `meta.category_path`（存在且安全）
    - 否则 fallback 到 `meta.category` / 默认分类

- `server/routes/prompts.js`
  - `PUT /api/prompts/:id`：
    - 解析 `categoryPath`
    - 使用 `path.normalize` 比较当前与目标，避免 Windows 分隔符导致误判
    - 变更则调用 `movePrompt`，再进行 `updatePrompt`

### 3.4 前端实现

- `src/types.ts`：增加 `PromptMetadata.category_path`
- `src/components/EditorPage.tsx`
  - 分类下拉 value 使用 `category_path`（而不是 name）
  - 保存时把 `meta.category_path` 带上
  - 兼容旧数据：若 `category_path` 缺失，根据 `prompt.path` 推导
- `src/adapters/ApiFileSystemAdapter.ts`
  - `savePrompt` 发送 `categoryPath`
  - 如果后端移动导致 `path` 变化，删除旧 `pathToId` 映射并写入新映射
- `src/AppContext_API.tsx`
  - API 模式下保存后如果检测到目录移动，调用 `loadVault()` 重新扫描，刷新分类树

### 3.5 常见问题与解决

#### 问题 A：目录移动了，但 UI 分类树没同步

- **现象**：磁盘目录已移动，列表仍显示在旧分类/树结构没变化
- **根因**：API 模式 `AppContext_API.savePrompt()` 只更新了 `allPrompts` Map，没有刷新 `categories` 树
- **解决**：当检测到 `path/category_path` 变化，执行 `loadVault()`
- **相关文件**：`src/AppContext_API.tsx`

#### 问题 B：移动逻辑偶现不触发

- **现象**：传了 `categoryPath`，但后端判断“没变”
- **根因**：Windows 分隔符与大小写差异导致 `current !== target` 判断不稳定
- **解决**：对比时用 `path.normalize`
- **相关文件**：`server/routes/prompts.js`

#### 问题 C：旧数据没有 `category_path` 导致编辑页分类空白

- **现象**：打开旧 Prompt 时分类下拉显示空
- **解决**：用 `prompt.path` 在分类树里“最长前缀匹配”推导 `category_path`
- **相关文件**：`src/components/EditorPage.tsx`

---

## 4. 一键对齐历史数据（normalize）

### 4.1 目的

当历史数据里 `meta.category_path` 缺失/不一致时，可以一键将所有 prompt 的 meta 按真实目录回填。

### 4.2 实现

- `server/utils/fileSystem.js`
  - `normalizePromptsCategoryPath(categories, vaultRoot)`：递归遍历分类树，读取每个 prompt，写回正确的 `category_path/category`
- `server/routes/vault.js`
  - `POST /api/vault/normalize`

### 4.3 注意事项

- 这是写入操作：会批量修改 `meta.json`
- 适合在迁移/升级后执行一次

---

## 5. UI 重设计（基于 view.md）

### 5.1 目标

- 暗色玻璃拟态 + 更现代的工程感
- 网格背景 + Aurora 渐变氛围
- Prompt 卡片：Spotlight 鼠标跟随发光
- Logo 自动丰富：根据标题/标签智能匹配图标 + 稳定渐变配色

### 5.2 实现位置

- `src/index.css`
  - 深色背景、滚动条、`bg-grid`、`aurora-bg`
  - `color-scheme: dark` 适配原生控件
  - `html/body/#root` 强制背景一致，避免视觉闪烁
- `src/App.tsx`
  - 背景层叠加（grid + aurora）
- `src/components/PromptList.tsx`
  - SpotlightCard
  - 新建弹窗暗色风格
  - 自定义分类下拉（见 6）
- `src/components/Sidebar.tsx`
  - 暗色玻璃拟态
- `src/components/EditorPage.tsx`
  - 编辑页暗色风格

---

## 6. 关键 UI Bug：Windows 下拉首次点击闪白

### 6.1 现象

- 在“新建页面”弹窗中，第一次点击分类下拉时，会出现一次明显的“闪白”

### 6.2 根因

- 原生 `<select>` 下拉面板由系统/浏览器控件绘制
- Windows/Chromium 首次展开时可能先按系统浅色主题绘制一帧，再切到暗色
- CSS 对 `option` 样式支持不一致，无法保证 100% 一致

### 6.3 解决方案（最终方案）

- **放弃原生 `<select>`**，改为“自定义 Popover 下拉”
  - 不依赖系统控件绘制
  - 统一暗色样式
  - 支持搜索、点击外部关闭、ESC 关闭

### 6.4 实现位置

- `src/components/PromptList.tsx`
  - `isCategoryOpen/categoryQuery/categoryPopoverRef`
  - `button + absolute popover + list`

---

## 7. 关键 UI Bug：点击分类列表闪一下 / 页面闪白

### 7.1 页面闪白

- **原因**：根节点背景未统一（`html/#root` 有时仍是默认白色）
- **解决**：在 `index.css` 强制 `html/body/#root` 背景为 `#09090b`

### 7.2 列表切换闪动

- **原因**：切分类瞬间 DOM 批量增删，配合 blur/透明层会更显眼
- **解决**：给列表容器加一个短暂 `opacity` 过渡（视觉缓冲）

---

## 8. 代码组织与复用：智能图标工具抽离

### 8.1 问题

- `getSmartIcon/getSmartGradient` 最开始在 `PromptList` 与 `EditorPage` 里各复制了一份
- 维护成本高，后续扩展图标规则会不一致

### 8.2 解决

- 抽离到 `src/utils/smartIcon.ts`
- 组件只 import 使用

---

## 9. 建议的回归验证清单

### 9.1 分类移动一致性

- 在编辑页改分类 → 保存
- 验证磁盘目录确实移动到目标分类
- 验证 UI 分类树与列表同步
- 检查 `meta.json` 中 `category/category_path` 是否正确

### 9.2 回收站

- 打开网站多次，回收站条目访问计数增长
- 达到阈值后条目被永久删除
- 回收站视图显示 `x/10`
- 恢复优先回原路径，其次按分类路径恢复

### 9.3 UI

- 新建弹窗分类选择无闪白
- 目录/分类切换无闪白
- 卡片 Spotlight 正常
- 智能 Logo 规则符合预期

---

## 10. 后续可选增强

- 将编辑页分类选择也改为自定义 Popover（与新建弹窗一致）
- 为分类树/列表切换增加 Skeleton Loading
- 为 `movePrompt` 增加“保持 slug 不变/可选重命名策略”的配置
